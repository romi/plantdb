<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>plantdb.fsdb &#8212; plantdb  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=83e35b93" />
    <link rel="stylesheet" type="text/css" href="../../_static/material.css?v=79c92029" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css?v=2a6c4383" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css?v=45cf7dbc" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css?v=d290406d" />
    <link rel="stylesheet" type="text/css" href="../../_static/_static/css/extra.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <link rel="icon" href="../../_static/ROMI_favicon_green.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=green data-md-color-accent=blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#_modules/plantdb/fsdb" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../index.html" title="plantdb  documentation"
           class="md-header-nav__button md-logo">
          
            &nbsp;
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">plantdb</span>
          <span class="md-header-nav__topic"> plantdb.fsdb </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder=""Search""
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/romi/plantdb/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    
  </div>
</a>
          </div>
        </div>
      
      
  
  <script src="../../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../../"versions.json"",
        target_loc = "../../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../../index.html" class="md-tabs__link">plantdb</a></li>
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">Module code</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../index.html" title="plantdb documentation" class="md-nav__button md-logo">
      
        <img src="../../_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../../index.html"
       title="plantdb documentation">plantdb</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/romi/plantdb/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    
  </div>
</a>
    </div>
  
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
  <ul class="md-nav__list" data-md-scrollfix="">
    

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <h1 id="modules-plantdb-fsdb--page-root">Source code for plantdb.fsdb</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># plantdb - Data handling tools for the ROMI project</span>
<span class="c1">#</span>
<span class="c1"># Copyright (C) 2018-2019 Sony Computer Science Laboratories</span>
<span class="c1"># Authors: D. Colliaux, T. Wintz, P. Hanappe</span>
<span class="c1">#</span>
<span class="c1"># This file is part of plantdb.</span>
<span class="c1">#</span>
<span class="c1"># plantdb is free software: you can redistribute it</span>
<span class="c1"># and/or modify it under the terms of the GNU Lesser General Public</span>
<span class="c1"># License as published by the Free Software Foundation, either</span>
<span class="c1"># version 3 of the License, or (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># plantdb is distributed in the hope that it will be</span>
<span class="c1"># useful, but WITHOUT ANY WARRANTY; without even the implied</span>
<span class="c1"># warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="c1"># See the GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public</span>
<span class="c1"># License along with plantdb.  If not, see</span>
<span class="c1"># &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="sd">"""Implementation of a database as a local file structure.</span>

<span class="sd">Assuming that the ``FSDB`` root database directory is ``dbroot/``, there is a ``Scan`` with ``'myscan_001'`` as ``Scan.id`` and there are some metadata (see below), you should have the following file structure:</span>

<span class="sd">.. code-block::</span>

<span class="sd">    dbroot/                            # base directory of the database</span>
<span class="sd">    ├── myscan_001/                    # scan dataset directory, id=`myscan_001`</span>
<span class="sd">    │   ├── files.json                 # JSON file referencing the all files for the dataset</span>
<span class="sd">    │   ├── images/                    # `Fileset` gathering the 'images'</span>
<span class="sd">    │   │   ├── scan_img_01.jpg        # 'image' `File` 01</span>
<span class="sd">    │   │   ├── scan_img_02.jpg        # 'image' `File` 02</span>
<span class="sd">    │   │   ├── [...]                  #</span>
<span class="sd">    │   │   └── scan_img_99.jpg        # 'image' `File` 99</span>
<span class="sd">    │   ├── metadata/                  # metadata directory</span>
<span class="sd">    │   │   ├── images                 # 'images' metadata directory</span>
<span class="sd">    │   │   │   ├── scan_img_01.json   # JSON metadata attached to this file</span>
<span class="sd">    │   │   │   ├── scan_img_02.json   #</span>
<span class="sd">    │   │   │   [...]                  #</span>
<span class="sd">    │   │   │   └── scan_img_99.json   #</span>
<span class="sd">    │   │   ├── Task_A/                # optional, only present if metadata attached to one of the outputs from `Task_A`</span>
<span class="sd">    │   │   │   └── outfile.json       # optional metadata attached to the output file from `Task_A`</span>
<span class="sd">    │   │   └── (metadata.json)        # optional metadata attached to the dataset</span>
<span class="sd">    │   ├── task_A/                    # `Fileset` gathering the outputs of `Task_A`</span>
<span class="sd">    │   │   └── outfile.ext            # output file from `Task_A`</span>
<span class="sd">    │   └── (measures.json)            # optional manual measurements file</span>
<span class="sd">    ├── myscan_002/                    # scan dataset directory, id=`myscan_002`</span>
<span class="sd">    :</span>
<span class="sd">    ├── (LOCK_FILE_NAME)               # "lock file", present if DB is connected</span>
<span class="sd">    └── MARKER_FILE_NAME               # ROMI DB marker file</span>

<span class="sd">The ``myscan_001/files.json`` file then contains the following structure:</span>

<span class="sd">.. code-block:: json</span>

<span class="sd">    {</span>
<span class="sd">        "filesets": [</span>
<span class="sd">            {</span>
<span class="sd">                "id": "images",</span>
<span class="sd">                "files": [</span>
<span class="sd">                    {</span>
<span class="sd">                        "id": "scan_img_01",</span>
<span class="sd">                        "file": "scan_img_01.jpg"</span>
<span class="sd">                    },</span>
<span class="sd">                    {</span>
<span class="sd">                        "id": "scan_img_02",</span>
<span class="sd">                        "file": "scan_img_02.jpg"</span>
<span class="sd">                    },</span>
<span class="sd">                    [...]</span>
<span class="sd">                    {</span>
<span class="sd">                        "id": "scan_img_99",</span>
<span class="sd">                        "file": "scan_img_99.jpg"</span>
<span class="sd">                    }</span>
<span class="sd">                ]</span>
<span class="sd">            }</span>
<span class="sd">        ]</span>
<span class="sd">    }</span>

<span class="sd">The metadata of the scan (``metadata.json``), of the set of 'images' files (``&lt;Fileset.id&gt;.json``) and of each 'image' files (``&lt;File.id&gt;.json``) are all stored as JSON files in a separate directory:</span>

<span class="sd">.. code-block::</span>

<span class="sd">    myscan_001/metadata/</span>
<span class="sd">    myscan_001/metadata/metadata.json</span>
<span class="sd">    myscan_001/metadata/images.json</span>
<span class="sd">    myscan_001/metadata/images/scan_img_01.json</span>
<span class="sd">    myscan_001/metadata/images/scan_img_02.json</span>
<span class="sd">    [...]</span>
<span class="sd">    myscan_001/metadata/images/scan_img_99.json</span>

<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copyfile</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>

<span class="kn">from</span> <span class="nn">plantdb</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">plantdb.db</span> <span class="kn">import</span> <span class="n">DBBusyError</span>
<span class="kn">from</span> <span class="nn">plantdb.log</span> <span class="kn">import</span> <span class="n">configure_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">configure_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1">#: This file must exist in the root of a folder for it to be considered a valid DB</span>
<span class="n">MARKER_FILE_NAME</span> <span class="o">=</span> <span class="s2">"romidb"</span>
<span class="c1">#: This file prevents opening the DB if it is present in the root folder of a DB</span>
<span class="n">LOCK_FILE_NAME</span> <span class="o">=</span> <span class="s2">"lock"</span>


<div class="viewcode-block" id="dummy_db"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.dummy_db">[docs]</a><span class="k">def</span> <span class="nf">dummy_db</span><span class="p">(</span><span class="n">with_scan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_fileset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create a dummy temporary database.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    with_scan : bool, optional</span>
<span class="sd">        Add a dummy ``Scan`` to the dummy database.</span>
<span class="sd">    with_fileset : bool, optional</span>
<span class="sd">        Add a dummy ``Fileset`` to the dummy database.</span>
<span class="sd">    with_file : bool, optional</span>
<span class="sd">        Add a dummy ``File`` to the dummy database.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plantdb.fsdb.FSDB</span>
<span class="sd">        The dummy database.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">    &gt;&gt;&gt; db = dummy_db()</span>
<span class="sd">    &gt;&gt;&gt; db.connect()</span>
<span class="sd">    &gt;&gt;&gt; print(db.is_connected)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; print(db.path())  # the database directory</span>
<span class="sd">    /tmp/romidb_********</span>

<span class="sd">    &gt;&gt;&gt; db = dummy_db(with_scan=True)</span>
<span class="sd">    &gt;&gt;&gt; db.connect()</span>
<span class="sd">    &gt;&gt;&gt; scan = db.get_scan("myscan_001")  # get the created scan</span>
<span class="sd">    &gt;&gt;&gt; print(type(scan))</span>
<span class="sd">    &lt;class 'NoneType'&gt;</span>
<span class="sd">    &gt;&gt;&gt; print(os.listdir(db.path()))</span>
<span class="sd">    ['lock', 'romidb', 'myscan_001']</span>
<span class="sd">    &gt;&gt;&gt; print(os.listdir(scan.path()))</span>
<span class="sd">    ['metadata']</span>

<span class="sd">    &gt;&gt;&gt; db = dummy_db(with_fileset=True)</span>
<span class="sd">    &gt;&gt;&gt; db.connect()</span>
<span class="sd">    &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">    &gt;&gt;&gt; print(os.listdir(scan.path()))</span>
<span class="sd">    ['metadata', 'files.json', 'fileset_001']</span>
<span class="sd">    &gt;&gt;&gt; fs = scan.get_fileset("fileset_001")</span>
<span class="sd">    &gt;&gt;&gt; print(type(fs))</span>
<span class="sd">    &lt;class 'plantdb.fsdb.Fileset'&gt;</span>
<span class="sd">    &gt;&gt;&gt; print(list(fs.path().iterdir()))  # the fileset is empty as no file has been created</span>
<span class="sd">    []</span>

<span class="sd">    &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">    &gt;&gt;&gt; db.connect()</span>
<span class="sd">    &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">    &gt;&gt;&gt; fs = scan.get_fileset("fileset_001")</span>
<span class="sd">    &gt;&gt;&gt; f = fs.get_file("test_image")</span>
<span class="sd">    &gt;&gt;&gt; print(type(f))</span>
<span class="sd">    &gt;&gt;&gt; print(list(fs.path().iterdir()))</span>
<span class="sd">    ['test_image.png', 'test_json.json']</span>
<span class="sd">    &gt;&gt;&gt; print(f.path())</span>

<span class="sd">    """</span>
    <span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">mkdtemp</span>
    <span class="kn">from</span> <span class="nn">plantdb</span> <span class="kn">import</span> <span class="n">io</span>

    <span class="n">mydb</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">'romidb_'</span><span class="p">))</span>
    <span class="n">marker_file</span> <span class="o">=</span> <span class="n">mydb</span> <span class="o">/</span> <span class="n">MARKER_FILE_NAME</span>
    <span class="n">marker_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">'w'</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">FSDB</span><span class="p">(</span><span class="n">mydb</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">with_file</span><span class="p">:</span>
        <span class="c1"># To create a `File`, existing `Scan` &amp; `Fileset` are required</span>
        <span class="n">with_scan</span><span class="p">,</span> <span class="n">with_fileset</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">with_fileset</span><span class="p">:</span>
        <span class="c1"># To create a `Fileset`, an existing `Scan` is required</span>
        <span class="n">with_scan</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Initialize an `FSDB` to add required objects:</span>
    <span class="k">if</span> <span class="n">with_scan</span> <span class="ow">or</span> <span class="n">with_fileset</span> <span class="ow">or</span> <span class="n">with_file</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="c1"># Create a `Scan` object if required:</span>
    <span class="k">if</span> <span class="n">with_scan</span><span class="p">:</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">create_scan</span><span class="p">(</span><span class="s2">"myscan_001"</span><span class="p">)</span>
        <span class="n">scan</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">"test"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Create a `Fileset` object if required:</span>
    <span class="k">if</span> <span class="n">with_fileset</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">create_fileset</span><span class="p">(</span><span class="s2">"fileset_001"</span><span class="p">)</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">"test_fileset"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Create a `Fileset` object if required:</span>
    <span class="k">if</span> <span class="n">with_file</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="c1"># -- Create a fixed dummy image:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">"dummy_image"</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'uint8'</span><span class="p">)</span>
        <span class="n">io</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="s2">"png"</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">"dummy image"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># -- Create a random RGB image:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">"test_image"</span><span class="p">)</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'uint8'</span><span class="p">)</span>
        <span class="n">io</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="s2">"png"</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">"random image"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># -- Create a dummy JSON</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">"test_json"</span><span class="p">)</span>
        <span class="n">md</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"Who you gonna call?"</span><span class="p">:</span> <span class="s2">"Ghostbuster"</span><span class="p">}</span>
        <span class="n">io</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="s2">"json"</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">"random json"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">with_scan</span> <span class="ow">or</span> <span class="n">with_fileset</span> <span class="ow">or</span> <span class="n">with_file</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">db</span></div>


<div class="viewcode-block" id="FSDB"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.FSDB">[docs]</a><span class="k">class</span> <span class="nc">FSDB</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DB</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Implement a local *File System DataBase* version of abstract class ``db.DB``.</span>

<span class="sd">    Implement as a simple local file structure with following directory structure and marker files:</span>
<span class="sd">      * directory ``${FSDB.basedir}`` as database root directory;</span>
<span class="sd">      * marker file ``MARKER_FILE_NAME`` at database root directory;</span>
<span class="sd">      * (OPTIONAL) lock file ``LOCK_FILE_NAME`` at database root directory when connected;</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    basedir : pathlib.Path</span>
<span class="sd">        Absolute path to the base directory hosting the database.</span>
<span class="sd">    lock_path : pathlib.Path</span>
<span class="sd">        Absolute path to the lock file.</span>
<span class="sd">    scans : list</span>
<span class="sd">        The list of ``Scan`` objects found in the database.</span>
<span class="sd">    is_connected : bool</span>
<span class="sd">        ``True`` if the database is connected (locked directory), else ``False``.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Requires the marker file ``MARKER_FILE_NAME`` at the given ``basedir``.</span>
<span class="sd">    Lock file ``LOCK_FILE_NAME`` is found only when connecting an FSBD instance to the given ``basedir``.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.db.DB</span>
<span class="sd">    plantdb.fsdb.MARKER_FILE_NAME</span>
<span class="sd">    plantdb.fsdb.LOCK_FILE_NAME</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # EXAMPLE 1: Use a temporary dummy local database:</span>
<span class="sd">    &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">    &gt;&gt;&gt; db = dummy_db()</span>
<span class="sd">    &gt;&gt;&gt; print(type(db))</span>
<span class="sd">    &lt;class 'plantdb.fsdb.FSDB'&gt;</span>
<span class="sd">    &gt;&gt;&gt; print(db.path())</span>
<span class="sd">    /tmp/romidb_********</span>
<span class="sd">    &gt;&gt;&gt; # Now connecting to this dummy local database...</span>
<span class="sd">    &gt;&gt;&gt; db.connect()</span>
<span class="sd">    &gt;&gt;&gt; # ...allows creating new `Scan` in it:</span>
<span class="sd">    &gt;&gt;&gt; new_scan = db.create_scan("007")</span>
<span class="sd">    &gt;&gt;&gt; print(type(new_scan))</span>
<span class="sd">    &lt;class 'plantdb.fsdb.Scan'&gt;</span>
<span class="sd">    &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">    &gt;&gt;&gt; # EXAMPLE 2: Use a local database:</span>
<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; from plantdb.fsdb import FSDB</span>
<span class="sd">    &gt;&gt;&gt; db = FSDB(os.environ.get('ROMI_DB', "/data/ROMI/DB/"))</span>
<span class="sd">    &gt;&gt;&gt; db.connect()</span>
<span class="sd">    &gt;&gt;&gt; [scan.id for scan in db.get_scans()]  # list scan ids found in database</span>
<span class="sd">    &gt;&gt;&gt; scan = db.get_scans()[1]</span>
<span class="sd">    &gt;&gt;&gt; [fs.id for fs in scan.get_filesets()]  # list fileset ids found in scan</span>
<span class="sd">    &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basedir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Database constructor.</span>

<span class="sd">        Check given ``basedir`` directory exists and load accessible ``Scan`` objects.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        basedir : str or pathlib.Path</span>
<span class="sd">            The path to the root directory of the database.</span>

<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># Defines attributes:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">basedir</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">/</span> <span class="n">LOCK_FILE_NAME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="FSDB.connect"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.FSDB.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Connect to the local database.</span>

<span class="sd">        Handle DB "locking" system by adding a `LOCK_FILE_NAME` file in the DB.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        login_data : bool</span>
<span class="sd">            UNUSED</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IOError</span>
<span class="sd">            If the given `basedir` is not an existing directory.</span>
<span class="sd">            If the `MARKER_FILE_NAME` is missing from the `basedir`.</span>
<span class="sd">        DBBusyError</span>
<span class="sd">            If the `LOCK_FILE_NAME` lock fil is found in the `basedir`.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        plantdb.fsdb.MARKER_FILE_NAME</span>
<span class="sd">        plantdb.fsdb.LOCK_FILE_NAME</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import FSDB</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db()</span>
<span class="sd">        &gt;&gt;&gt; print(db.is_connected)</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; print(db.is_connected)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="c1"># Check the given path to root directory of the database is a directory:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Not a directory: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="c1"># Check the given path to root directory of the database is a "romi DB", i.e. have the `MARKER_FILE_NAME`:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_fsdb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Not a DB! Check that there is a file named </span><span class="si">{</span><span class="n">MARKER_FILE_NAME</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">"x"</span><span class="p">)</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="o">=</span> <span class="n">_load_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DBBusyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File </span><span class="si">{</span><span class="n">LOCK_FILE_NAME</span><span class="si">}</span><span class="s2"> exists in DB root: DB is busy, cannot connect."</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Already connected to the database '</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="FSDB.disconnect"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.FSDB.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Disconnect from the local database.</span>

<span class="sd">        Handle DB "locking" system by removing the `LOCK_FILE_NAME` file from the DB.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IOError</span>
<span class="sd">            If the `LOCK_FILE_NAME` cannot be removed using the ``lock_path`` attribute.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db()</span>
<span class="sd">        &gt;&gt;&gt; print(db.is_connected)</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; print(db.is_connected)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>
<span class="sd">        &gt;&gt;&gt; print(db.is_connected)</span>
<span class="sd">        False</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">_erase</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">_is_safe_to_delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lock_path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lock_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">atexit</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">"Could not remove lock, maybe you messed with the `lock_path` attribute?"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Already disconnected from the database '</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="FSDB.get_scans"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.FSDB.get_scans">[docs]</a>    <span class="k">def</span> <span class="nf">get_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get the list of `Scan` instances defined in the local database, possibly filtered using a `query`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query : dict, optional</span>
<span class="sd">            Query to use to get a list of scans.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of plantdb.fsdb.Scan</span>
<span class="sd">            List of `Scan`s, filtered by the `query` if any.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        plantdb.fsdb._filter_query</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; db.get_scans()</span>
<span class="sd">        [&lt;plantdb.fsdb.Scan at *x************&gt;]</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">_filter_query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span></div>

<div class="viewcode-block" id="FSDB.get_scan"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.FSDB.get_scan">[docs]</a>    <span class="k">def</span> <span class="nf">get_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get or create a `Scan` instance in the local database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id : str</span>
<span class="sd">            The name of the scan dataset to get/create.</span>
<span class="sd">            It should exist if `create` is `False`.</span>
<span class="sd">        create : bool, optional</span>
<span class="sd">            If ``False`` (default), the given `id` should exist in the local database.</span>
<span class="sd">            Else the given `id` should NOT exist as they are unique.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If the `id` do not exist in the local database and `create` is `False`, `None` is returned.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; db.list_scans()</span>
<span class="sd">        ['myscan_001']</span>
<span class="sd">        &gt;&gt;&gt; new_scan = db.get_scan('007', create=True)</span>
<span class="sd">        &gt;&gt;&gt; print(new_scan)</span>
<span class="sd">        &lt;plantdb.fsdb.Scan object at **************&gt;</span>
<span class="sd">        &gt;&gt;&gt; db.list_scans()</span>
<span class="sd">        ['myscan_001', '007']</span>
<span class="sd">        &gt;&gt;&gt; unknown_scan = db.get_scan('unknown')</span>
<span class="sd">        &gt;&gt;&gt; print(unknown_scan)</span>
<span class="sd">        None</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_scan</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">[</span><span class="n">ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">id</span><span class="p">)]</span></div>

<div class="viewcode-block" id="FSDB.create_scan"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.FSDB.create_scan">[docs]</a>    <span class="k">def</span> <span class="nf">create_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Create a new `Scan` instance in the local database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id : str</span>
<span class="sd">            The name of the scan to create. It should not exist in the local database.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plantdb.fsdb.Scan</span>
<span class="sd">            The `Scan` instance created in the local database.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IOError</span>
<span class="sd">            If the `id` already exists in the local database.</span>
<span class="sd">            If the `id` is not valid.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        plantdb.fsdb._is_valid_id</span>
<span class="sd">        plantdb.fsdb._make_scan</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db()</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; new_scan = db.create_scan('007')</span>
<span class="sd">        &gt;&gt;&gt; scan = db.create_scan('007')</span>
<span class="sd">        OSError: Duplicate scan name: 007</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_valid_id</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">"Invalid id"</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Duplicate scan name: </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="n">Scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="n">_make_scan</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scan</span></div>

<div class="viewcode-block" id="FSDB.delete_scan"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.FSDB.delete_scan">[docs]</a>    <span class="k">def</span> <span class="nf">delete_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Delete an existing `Scan` from the local database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id : str</span>
<span class="sd">            The name of the scan to create. It should exist in the local database.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IOError</span>
<span class="sd">            If the `id` do not exist in the local database.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        plantdb.fsdb._delete_scan</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import FSDB</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db()</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; new_scan = db.create_scan('007')</span>
<span class="sd">        &gt;&gt;&gt; print(new_scan)</span>
<span class="sd">        &lt;plantdb.fsdb.Scan object at 0x7f0730b1e390&gt;</span>
<span class="sd">        &gt;&gt;&gt; db.delete_scan('007')</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan('007')</span>
<span class="sd">        &gt;&gt;&gt; print(scan)</span>
<span class="sd">        None</span>
<span class="sd">        &gt;&gt;&gt; db.delete_scan('008')</span>
<span class="sd">        OSError: Invalid id</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scan</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">"Invalid id"</span><span class="p">)</span>
        <span class="n">_delete_scan</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="FSDB.path"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.FSDB.path">[docs]</a>    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get the path to the local database root directory.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_scan=True, with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; db.path()</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">)</span></div>

<div class="viewcode-block" id="FSDB.list_scans"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.FSDB.list_scans">[docs]</a>    <span class="k">def</span> <span class="nf">list_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get the list of scans in the local database.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_scan=True, with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; db.list_scans()</span>
<span class="sd">        ['myscan_001']</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scans</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span></div></div>


<div class="viewcode-block" id="Scan"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Scan">[docs]</a><span class="k">class</span> <span class="nc">Scan</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Implement ``Scan`` for the local *File System DataBase* from abstract class ``db.Scan``.</span>

<span class="sd">    Implementation of a scan as a simple file structure with:</span>
<span class="sd">      * directory ``${Scan.db.basedir}/${Scan.db.id}`` as scan root directory;</span>
<span class="sd">      * (OPTIONAL) directory ``${Scan.db.basedir}/${Scan.db.id}/metadata`` containing JSON metadata file</span>
<span class="sd">      * (OPTIONAL) JSON file ``metadata.json`` with Scan metadata</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    db : plantdb.fsdb.FSDB</span>
<span class="sd">        Database where to find the scan.</span>
<span class="sd">    id : str</span>
<span class="sd">        The scan unique name in the local database.</span>
<span class="sd">    metadata : dict</span>
<span class="sd">        Dictionary of metadata attached to the scan.</span>
<span class="sd">    filesets : list of plantdb.fsdb.Fileset</span>
<span class="sd">        List of ``Fileset`` objects.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Optional directory ``metadata`` &amp; JSON file ``metadata.json`` are found when using method ``set_metadata()``.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.db.Scan</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; from plantdb.fsdb import Scan</span>
<span class="sd">    &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">    &gt;&gt;&gt; db = dummy_db()</span>
<span class="sd">    &gt;&gt;&gt; # Example #1: Initialize a `Scan` object using an `FSBD` object:</span>
<span class="sd">    &gt;&gt;&gt; scan = Scan(db, '007')</span>
<span class="sd">    &gt;&gt;&gt; print(type(scan))</span>
<span class="sd">    &lt;class 'plantdb.fsdb.Scan'&gt;</span>
<span class="sd">    &gt;&gt;&gt; print(scan.path())  # the obtained path should be different as the path to the created `dummy_db` change...</span>
<span class="sd">    /tmp/romidb_j0pbkoo0/007</span>
<span class="sd">    &gt;&gt;&gt; print(db.get_scan('007'))  # Note that it did NOT create this `Scan` in the database!</span>
<span class="sd">    None</span>
<span class="sd">    &gt;&gt;&gt; print(os.listdir(db.path()))  # And it is NOT found under the `basedir` directory</span>
<span class="sd">    ['romidb']</span>
<span class="sd">    &gt;&gt;&gt; # HOWEVER if you add metadata to the `Scan` object:</span>
<span class="sd">    &gt;&gt;&gt; scan.set_metadata({'Name': "Bond... James Bond!"})</span>
<span class="sd">    &gt;&gt;&gt; print(scan.metadata)</span>
<span class="sd">    {'Name': 'Bond... James Bond!'}</span>
<span class="sd">    &gt;&gt;&gt; print(db.get_scan('007'))  # The `Scan` is still not found in the database!</span>
<span class="sd">    None</span>
<span class="sd">    &gt;&gt;&gt; print(os.listdir(db.path()))  # BUT it is now found under the `basedir` directory</span>
<span class="sd">    ['007', 'romidb']</span>
<span class="sd">    &gt;&gt;&gt; print(os.listdir(os.path.join(db.path(), scan.id)))  # Same goes for the metadata</span>
<span class="sd">    ['metadata']</span>
<span class="sd">    &gt;&gt;&gt; print(os.listdir(os.path.join(db.path(), scan.id, "metadata")))  # Same goes for the metadata</span>
<span class="sd">    &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">    &gt;&gt;&gt; # Example #2: Get it from an `FSDB` object:</span>
<span class="sd">    &gt;&gt;&gt; db = dummy_db()</span>
<span class="sd">    &gt;&gt;&gt; scan = db.get_scan('007', create=True)</span>
<span class="sd">    &gt;&gt;&gt; print(type(scan))</span>
<span class="sd">    &lt;class 'plantdb.fsdb.Scan'&gt;</span>
<span class="sd">    &gt;&gt;&gt; print(db.get_scan('007'))  # This time the `Scan` object is found in the `FSBD`</span>
<span class="sd">    &lt;plantdb.fsdb.Scan object at 0x7f34fc860fd0&gt;</span>
<span class="sd">    &gt;&gt;&gt; print(os.listdir(db.path()))  # And it is found under the `basedir` directory</span>
<span class="sd">    ['007', 'romidb']</span>
<span class="sd">    &gt;&gt;&gt; print(os.listdir(os.path.join(db.path(), scan.id)))  # Same goes for the metadata</span>
<span class="sd">    ['metadata']</span>
<span class="sd">    &gt;&gt;&gt; db.disconnect()</span>
<span class="sd">    &gt;&gt;&gt; # When reconnecting to db, if created scan is EMPTY (no Fileset &amp; File) it is not found!</span>
<span class="sd">    &gt;&gt;&gt; db.connect()</span>
<span class="sd">    &gt;&gt;&gt; print(db.get_scan('007'))</span>
<span class="sd">    None</span>

<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Scan dataset constructor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        db : plantdb.fsdb.FSDB</span>
<span class="sd">            The database to put/find the scan dataset.</span>
<span class="sd">        id : str</span>
<span class="sd">            The scan dataset name, should be unique in the `db`.</span>
<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="c1"># Defines attributes:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measures</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filesets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_erase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Erase the filesets and metadata associated to this scan."""</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesets</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">_erase</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesets</span>
        <span class="k">return</span>

<div class="viewcode-block" id="Scan.get_filesets"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Scan.get_filesets">[docs]</a>    <span class="k">def</span> <span class="nf">get_filesets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get the list of `Fileset` instances defined in the current scan dataset, possibly filtered using a `query`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query : dict, optional</span>
<span class="sd">            Query to use to get a list of filesets.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of plantdb.fsdb.Fileset</span>
<span class="sd">            List of `Fileset`s, filtered by the `query` if any.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        plantdb.fsdb._filter_query</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan('myscan_001')</span>
<span class="sd">        &gt;&gt;&gt; scan.get_filesets()</span>
<span class="sd">        [&lt;plantdb.fsdb.Fileset at *x************&gt;]</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">_filter_query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filesets</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scan.get_fileset"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Scan.get_fileset">[docs]</a>    <span class="k">def</span> <span class="nf">get_fileset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get or create a `Fileset` instance, of given `id`, in the current scan dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id : str</span>
<span class="sd">            The name of the fileset to get/create.</span>
<span class="sd">            It should exist if `create` is `False`.</span>
<span class="sd">        create : bool, optional</span>
<span class="sd">            If ``False`` (default), the given `id` should exist in the local database.</span>
<span class="sd">            Else the given `id` should NOT exist as they are unique.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Fileset</span>
<span class="sd">            The retrieved or created fileset.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If the `id` do not exist in the local database and `create` is `False`, `None` is returned.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan('myscan_001')</span>
<span class="sd">        &gt;&gt;&gt; scan.list_filesets()</span>
<span class="sd">        ['fileset_001']</span>
<span class="sd">        &gt;&gt;&gt; new_fileset = scan.get_fileset('007', create=True)</span>
<span class="sd">        &gt;&gt;&gt; print(new_fileset)</span>
<span class="sd">        &lt;plantdb.fsdb.Fileset object at **************&gt;</span>
<span class="sd">        &gt;&gt;&gt; scan.list_filesets()</span>
<span class="sd">        ['fileset_001', '007']</span>
<span class="sd">        &gt;&gt;&gt; unknown_fs = scan.get_fileset('unknown')</span>
<span class="sd">        &gt;&gt;&gt; print(unknown_fs)</span>
<span class="sd">        None</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesets</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_fileset</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesets</span><span class="p">[</span><span class="n">ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">id</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Scan.get_metadata"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Scan.get_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get the metadata associated to a scan.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : str</span>
<span class="sd">            A key that should exist in the scan's metadata.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        any</span>
<span class="sd">            If `key` is ``None``, returns a dictionary.</span>
<span class="sd">            Else, returns the value attached to this key.</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">_get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scan.get_measures"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Scan.get_measures">[docs]</a>    <span class="k">def</span> <span class="nf">get_measures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get the manual measurements associated to a scan.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : str</span>
<span class="sd">            A key that should exist in the scan's manual measurements.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        any</span>
<span class="sd">            If `key` is ``None``, returns a dictionary.</span>
<span class="sd">            Else, returns the value attached to this key.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        These manual measurements should be a JSON file named `measures.json`.</span>
<span class="sd">        It is located at the root folder of the scan dataset.</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">_get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scan.set_metadata"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Scan.set_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">set_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Add a new metadata to the scan.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : str or dict</span>
<span class="sd">            If a string, a key to address the `value`.</span>
<span class="sd">            If a dictionary, update the metadata dictionary with `data` (`value` is then unused).</span>
<span class="sd">        value : any, optional</span>
<span class="sd">            The value to assign to `data` if the latest is not a dictionary.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import json</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import _scan_metadata_path</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; scan.set_metadata("test", "value")</span>
<span class="sd">        &gt;&gt;&gt; p = _scan_metadata_path(scan)</span>
<span class="sd">        &gt;&gt;&gt; print(p.exists())</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; print(json.load(p.open(mode='r')))</span>
<span class="sd">        {'test': 'value'}</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">_set_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">_store_scan_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Scan.create_fileset"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Scan.create_fileset">[docs]</a>    <span class="k">def</span> <span class="nf">create_fileset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Create a new `Fileset` instance in the local database attached to the current `Scan` instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id : str</span>
<span class="sd">            The name of the fileset to create. It should not exist in the current `Scan` instance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plantdb.fsdb.Fileset</span>
<span class="sd">            The `Fileset` instance created in the current `Scan` instance.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IOError</span>
<span class="sd">            If the `id` already exists in the current `Scan` instance.</span>
<span class="sd">            If the `id` is not valid.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        plantdb.fsdb._is_valid_id</span>
<span class="sd">        plantdb.fsdb._make_fileset</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan('myscan_001')</span>
<span class="sd">        &gt;&gt;&gt; scan.list_filesets()</span>
<span class="sd">        ['fileset_001']</span>
<span class="sd">        &gt;&gt;&gt; new_fs = scan.create_fileset('fs_007')</span>
<span class="sd">        &gt;&gt;&gt; scan.list_filesets()</span>
<span class="sd">        ['fileset_001', 'fs_007']</span>
<span class="sd">        &gt;&gt;&gt; wrong_fs = scan.create_fileset('fileset_001')</span>
<span class="sd">        OSError: Duplicate scan name: fileset_001</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_valid_id</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid fileset id: </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fileset</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Duplicate fileset name: </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">fileset</span> <span class="o">=</span> <span class="n">Fileset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="n">_make_fileset</span><span class="p">(</span><span class="n">fileset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filesets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fileset</span></div>

<div class="viewcode-block" id="Scan.store"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Scan.store">[docs]</a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Save changes to the scan main JSON FILE (files.json)."""</span>
        <span class="n">_store_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"The `files.json` file for scan '</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">' has been updated!"</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Scan.delete_fileset"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Scan.delete_fileset">[docs]</a>    <span class="k">def</span> <span class="nf">delete_fileset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileset_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Delete a given fileset from the scan dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fileset_id : str</span>
<span class="sd">            Name of the fileset to delete.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan('myscan_001')</span>
<span class="sd">        &gt;&gt;&gt; scan.list_filesets()</span>
<span class="sd">        ['fileset_001']</span>
<span class="sd">        &gt;&gt;&gt; scan.delete_fileset('fileset_001')</span>
<span class="sd">        &gt;&gt;&gt; scan.list_filesets()</span>
<span class="sd">        []</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fileset</span><span class="p">(</span><span class="n">fileset_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not get the Fileset to delete: '</span><span class="si">{</span><span class="n">fileset_id</span><span class="si">}</span><span class="s2">'!"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">_delete_fileset</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filesets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Scan.path"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Scan.path">[docs]</a>    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get the path to the local scan dataset.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; scan.path()  # should be '/tmp/romidb_********/myscan_001'</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">_scan_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scan.list_filesets"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Scan.list_filesets">[docs]</a>    <span class="k">def</span> <span class="nf">list_filesets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get the list of filesets in the scan dataset.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; scan.list_filesets()</span>
<span class="sd">        ['fileset_001']</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filesets</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span></div></div>


<div class="viewcode-block" id="Fileset"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Fileset">[docs]</a><span class="k">class</span> <span class="nc">Fileset</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Fileset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Implement ``Fileset`` for the local *File System DataBase* from abstract class ``db.Fileset``.</span>

<span class="sd">    Implementation of a fileset as a simple files structure with:</span>
<span class="sd">      * directory ``${FSDB.basedir}/${FSDB.scan.id}/${Fileset.id}`` containing set of files;</span>
<span class="sd">      * directory ``${FSDB.basedir}/${FSDB.scan.id}/metadata`` containing JSON metadata associated to files;</span>
<span class="sd">      * JSON file ``files.json`` containing the list of files from fileset;</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    db : plantdb.fsdb.FSDB</span>
<span class="sd">        Database where to find the `scan`.</span>
<span class="sd">    id : str</span>
<span class="sd">        Name of the scan in the database `db`.</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        Scan containing the set of files of interest.</span>
<span class="sd">    metadata : dict</span>
<span class="sd">        Dictionary of metadata attached to the fileset.</span>
<span class="sd">    files : list of plantdb.fsdb.File</span>
<span class="sd">        List of `File` objects.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.db.Fileset</span>

<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_erase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">_erase</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span>

<div class="viewcode-block" id="Fileset.get_files"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Fileset.get_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get the list of `File` instances defined in the current fileset, possibly filtered using a `query`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        query : dict, optional</span>
<span class="sd">            Query to use to get a list of files.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of plantdb.fsdb.File</span>
<span class="sd">            List of `File`s, filtered by the query if any.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        plantdb.fsdb._filter_query</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan('myscan_001')</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset('fileset_001')</span>
<span class="sd">        &gt;&gt;&gt; fs.get_files()</span>
<span class="sd">        [&lt;plantdb.fsdb.File at *x************&gt;,</span>
<span class="sd">         &lt;plantdb.fsdb.File at *x************&gt;,</span>
<span class="sd">         &lt;plantdb.fsdb.File at *x************&gt;]</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">_filter_query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fileset.get_file"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Fileset.get_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get or create a `File` instance, of given `id`, in the current fileset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id : str</span>
<span class="sd">            Name of the file to get/create.</span>
<span class="sd">        create : bool</span>
<span class="sd">            If ``False`` (default), the given `id` should exist in the local database.</span>
<span class="sd">            Else the given `id` should NOT exist as they are unique.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plantdb.fsdb.File</span>
<span class="sd">            The retrieved or created file.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset("fileset_001")</span>
<span class="sd">        &gt;&gt;&gt; f = fs.get_file("test_image")</span>
<span class="sd">        &gt;&gt;&gt; # To read the file you need to load the right reader from plantdb.io</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.io import read_image</span>
<span class="sd">        &gt;&gt;&gt; img = read_image(f)</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">ids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">id</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Fileset.get_metadata"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Fileset.get_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get the metadata associated to a fileset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : str</span>
<span class="sd">            A key that should exist in the fileset's metadata.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        any</span>
<span class="sd">            If `key` is ``None``, returns a dictionary.</span>
<span class="sd">            Else, returns the value attached to this key.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import json</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset('fileset_001')</span>
<span class="sd">        &gt;&gt;&gt; fs.set_metadata("test", "value")</span>
<span class="sd">        &gt;&gt;&gt; print(fs.get_metadata("test"))</span>
<span class="sd">        'value'</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset('fileset_001')</span>
<span class="sd">        &gt;&gt;&gt; print(fs.get_metadata("test"))</span>
<span class="sd">        'value'</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">_get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fileset.set_metadata"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Fileset.set_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">set_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Add a new metadata to the fileset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : str or dict</span>
<span class="sd">            If a string, a key to address the `value`.</span>
<span class="sd">            If a dictionary, update the metadata dictionary with `data` (`value` is then unused).</span>
<span class="sd">        value : any, optional</span>
<span class="sd">            The value to assign to `data` if the latest is not a dictionary.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import json</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import _fileset_metadata_json_path</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset('fileset_001')</span>
<span class="sd">        &gt;&gt;&gt; fs.set_metadata("test", "value")</span>
<span class="sd">        &gt;&gt;&gt; p = _fileset_metadata_json_path(fs)</span>
<span class="sd">        &gt;&gt;&gt; print(p.exists())</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; print(json.load(p.open(mode='r')))</span>
<span class="sd">        {'test': 'value'}</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">_set_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">_store_fileset_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Fileset.create_file"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Fileset.create_file">[docs]</a>    <span class="k">def</span> <span class="nf">create_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Create a new `File` instance in the local database attached to the current `Fileset` instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id : str</span>
<span class="sd">            The name of the file to create.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plantdb.fsdb.File</span>
<span class="sd">            The `File` instance created in the current `Fileset` instance.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan('myscan_001')</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset('fileset_001')</span>
<span class="sd">        &gt;&gt;&gt; fs.list_files()</span>
<span class="sd">        ['dummy_image', 'test_image', 'test_json']</span>
<span class="sd">        &gt;&gt;&gt; new_f = fs.create_file('file_007')</span>
<span class="sd">        &gt;&gt;&gt; fs.list_files()</span>
<span class="sd">        ['dummy_image', 'test_image', 'test_json', 'file_007']</span>
<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; os.listdir(fs.path())  # the file only exist in the database, not on drive!</span>
<span class="sd">        ['test_image.png', 'test_json.json', 'dummy_image.png']</span>
<span class="sd">        &gt;&gt;&gt; md = {"Name": "Bond, James Bond"}  # Create an example dictionary to save as JSON</span>
<span class="sd">        &gt;&gt;&gt; from plantdb import io</span>
<span class="sd">        &gt;&gt;&gt; io.write_json(new_f, md, "json")  # write the file on drive</span>
<span class="sd">        &gt;&gt;&gt; os.listdir(fs.path())</span>
<span class="sd">        ['file_007.json', 'test_image.png', 'test_json.json', 'dummy_image.png']</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">file</span></div>

<div class="viewcode-block" id="Fileset.delete_file"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Fileset.delete_file">[docs]</a>    <span class="k">def</span> <span class="nf">delete_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Delete a given file from the current fileset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fileset_id : str</span>
<span class="sd">            Name of the file to delete.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan('myscan_001')</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset('fileset_001')</span>
<span class="sd">        &gt;&gt;&gt; fs.list_files()</span>
<span class="sd">        ['dummy_image', 'test_image', 'test_json']</span>
<span class="sd">        &gt;&gt;&gt; fs.delete_file('dummy_image')</span>
<span class="sd">        delete /tmp/romidb_********/myscan_001/fileset_001/dummy_image.png</span>
<span class="sd">        &gt;&gt;&gt; fs.list_files()</span>
<span class="sd">        ['test_image', 'test_json']</span>
<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; list(fs.path().iterdir())  # the file has been removed from the drive and the database</span>
<span class="sd">        ['test_image.png', 'test_json.json']</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid file ID: </span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">_delete_file</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Fileset.store"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Fileset.store">[docs]</a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Save changes to the scan main JSON FILE (files.json)."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Fileset.path"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Fileset.path">[docs]</a>    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get the path to the local fileset.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_scan=True, with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; [scan.id for scan in db.get_scans()]  # list scan ids found in database</span>
<span class="sd">        ['myscan_001']</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; print(scan.path())  # should be '/tmp/romidb_********/myscan_001'</span>
<span class="sd">        &gt;&gt;&gt; [fs.id for fs in scan.get_filesets()]  # list fileset ids found in scan</span>
<span class="sd">        ['fileset_001']</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset("fileset_001")</span>
<span class="sd">        &gt;&gt;&gt; print(fs.path())  # should be '/tmp/romidb_********/myscan_001/fileset_001'</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">_fileset_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fileset.list_files"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.Fileset.list_files">[docs]</a>    <span class="k">def</span> <span class="nf">list_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get the list of files in the fileset.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_scan=True, with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset("fileset_001")</span>
<span class="sd">        &gt;&gt;&gt; fs.list_files()</span>
<span class="sd">        ['dummy_image', 'test_image', 'test_json']</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_files</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span></div></div>


<div class="viewcode-block" id="File"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.File">[docs]</a><span class="k">class</span> <span class="nc">File</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">File</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Implement ``File`` for the local *File System DataBase* from abstract class ``db.File``.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    db : plantdb.fsdb.FSDB</span>
<span class="sd">        Database where to find the scan</span>
<span class="sd">    fileset : plantdb.fsdb.Fileset</span>
<span class="sd">        Set of files containing the file.</span>
<span class="sd">    id : str</span>
<span class="sd">        Name of the file in the ``FSDB`` local database.</span>
<span class="sd">    filename : str</span>
<span class="sd">        File name.</span>
<span class="sd">    metadata : dict</span>
<span class="sd">        Dictionary of metadata attached to the file.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.db.File</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    `File` must be writen using ``write_raw`` or ``write`` methods to exist on disk.</span>
<span class="sd">    Else they are just referenced in the database!</span>

<span class="sd">    Contrary to other classes (``Scan`` &amp; ``Fileset``) the uniqueness is not checked!</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">fileset</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">fileset</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_erase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span>

<div class="viewcode-block" id="File.get_metadata"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.File.get_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get the metadata associated to a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key : str</span>
<span class="sd">            A key that should exist in the file's metadata.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        any</span>
<span class="sd">            If `key` is ``None``, returns a dictionary.</span>
<span class="sd">            Else, returns the value attached to this key.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import _file_metadata_path</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset('fileset_001')</span>
<span class="sd">        &gt;&gt;&gt; f = fs.get_file("test_json")</span>
<span class="sd">        &gt;&gt;&gt; print(f.get_metadata())</span>
<span class="sd">        {'random json': True}</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">_get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="File.set_metadata"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.File.set_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">set_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Add a new metadata to the file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : str or dict</span>
<span class="sd">            If a string, a key to address the `value`.</span>
<span class="sd">            If a dictionary, update the metadata dictionary with `data` (`value` is then unused).</span>
<span class="sd">        value : any, optional</span>
<span class="sd">            The value to assign to `data` if the latest is not a dictionary.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import json</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import _file_metadata_path</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset('fileset_001')</span>
<span class="sd">        &gt;&gt;&gt; file = fs.get_file("test_json")</span>
<span class="sd">        &gt;&gt;&gt; file.set_metadata("test", "value")</span>
<span class="sd">        &gt;&gt;&gt; p = _file_metadata_path(file)</span>
<span class="sd">        &gt;&gt;&gt; print(p.exists())</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; print(json.load(p.open(mode='r')))</span>
<span class="sd">        {'random json': True, 'test': 'value'}</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">_set_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">_store_file_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="File.import_file"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.File.import_file">[docs]</a>    <span class="k">def</span> <span class="nf">import_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Import the file from its local path to the current fileset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str or pathlib.Path</span>
<span class="sd">            The path to the file to import.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import _file_metadata_path</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset('fileset_001')</span>
<span class="sd">        &gt;&gt;&gt; file = fs.get_file("test_json")</span>
<span class="sd">        &gt;&gt;&gt; new_file = fs.create_file('test_json2')</span>
<span class="sd">        &gt;&gt;&gt; new_file.import_file(file.path())</span>
<span class="sd">        &gt;&gt;&gt; print(new_file.path().exists())</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
        <span class="n">newpath</span> <span class="o">=</span> <span class="n">_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">copyfile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">newpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="File.store"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.File.store">[docs]</a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Save changes to the scan main JSON FILE (files.json)."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileset</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="File.read_raw"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.File.read_raw">[docs]</a>    <span class="k">def</span> <span class="nf">read_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Read the file and return its contents.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bytes</span>
<span class="sd">            The contents of the file.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset("fileset_001")</span>
<span class="sd">        &gt;&gt;&gt; f = fs.get_file("test_json")</span>
<span class="sd">        &gt;&gt;&gt; js = f.read_raw()</span>
<span class="sd">        &gt;&gt;&gt; print(js)  # print the raw bytes content</span>
<span class="sd">        &gt;&gt;&gt; # Convert this raw json into a dictionary with dedicated method from `json` library:</span>
<span class="sd">        &gt;&gt;&gt; import json</span>
<span class="sd">        &gt;&gt;&gt; js_dict = json.loads(js)</span>
<span class="sd">        &gt;&gt;&gt; print(js_dict)</span>
<span class="sd">        {'Who you gonna call?': 'Ghostbuster'}</span>
<span class="sd">        &gt;&gt;&gt; print(type(js_dict))</span>
<span class="sd">        &lt;class 'dict'&gt;</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>

<div class="viewcode-block" id="File.write_raw"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.File.write_raw">[docs]</a>    <span class="k">def</span> <span class="nf">write_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s2">""</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Write a file from raw byte data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : bytes</span>
<span class="sd">            The raw byte content to write.</span>
<span class="sd">        ext : str, optional</span>
<span class="sd">            The extension to use to save the file.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset("fileset_001")</span>
<span class="sd">        &gt;&gt;&gt; new_f = fs.create_file('file_007')</span>
<span class="sd">        &gt;&gt;&gt; md = {"Name": "Bond, James Bond"}  # Create an example dictionary to save as JSON</span>
<span class="sd">        &gt;&gt;&gt; import json</span>
<span class="sd">        &gt;&gt;&gt; data = json.dumps(md).encode()</span>
<span class="sd">        &gt;&gt;&gt; print(data)</span>
<span class="sd">        b'{"Name": "Bond, James Bond"}'</span>
<span class="sd">        &gt;&gt;&gt; new_f.write_raw(data, 'json')</span>
<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; os.listdir(fs.path())</span>
<span class="sd">        ['file_007.json', 'test_image.png', 'test_json.json', 'dummy_image.png']</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="File.read"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.File.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Read the file and return its contents.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The contents of the file.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset("fileset_001")</span>
<span class="sd">        &gt;&gt;&gt; f = fs.get_file("test_json")</span>
<span class="sd">        &gt;&gt;&gt; js = f.read()</span>
<span class="sd">        &gt;&gt;&gt; print(js)  # print the content of the file</span>
<span class="sd">        {</span>
<span class="sd">            "Who you gonna call?": "Ghostbuster"</span>
<span class="sd">        }</span>
<span class="sd">        &gt;&gt;&gt; # Convert this raw json into a dictionary with dedicated method from `json` library:</span>
<span class="sd">        &gt;&gt;&gt; import json</span>
<span class="sd">        &gt;&gt;&gt; js_dict = json.loads(js)</span>
<span class="sd">        &gt;&gt;&gt; print(js_dict)</span>
<span class="sd">        {'Who you gonna call?': 'Ghostbuster'}</span>
<span class="sd">        &gt;&gt;&gt; print(type(js_dict))</span>
<span class="sd">        &lt;class 'dict'&gt;</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>

<div class="viewcode-block" id="File.write"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.File.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s2">""</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Write a file from data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : str</span>
<span class="sd">            A string representation of the content to write.</span>
<span class="sd">        ext : str, optional</span>
<span class="sd">            The extension to use to save the file.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset("fileset_001")</span>
<span class="sd">        &gt;&gt;&gt; new_f = fs.create_file('file_007')</span>
<span class="sd">        &gt;&gt;&gt; md = {"Name": "Bond, James Bond"}  # Create an example dictionary to save as JSON</span>
<span class="sd">        &gt;&gt;&gt; import json</span>
<span class="sd">        &gt;&gt;&gt; data = json.dumps(md)</span>
<span class="sd">        &gt;&gt;&gt; print(data)</span>
<span class="sd">        {"Name": "Bond, James Bond"}</span>
<span class="sd">        &gt;&gt;&gt; print(type(data))</span>
<span class="sd">        &lt;class 'str'&gt;</span>
<span class="sd">        &gt;&gt;&gt; new_f.write(data, 'json')</span>
<span class="sd">        &gt;&gt;&gt; import os</span>
<span class="sd">        &gt;&gt;&gt; os.listdir(fs.path())</span>
<span class="sd">        ['file_007.json', 'test_image.png', 'test_json.json', 'dummy_image.png']</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">_get_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="File.path"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.File.path">[docs]</a>    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get the path to the local file.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">        &gt;&gt;&gt; db = dummy_db(with_scan=True, with_file=True)</span>
<span class="sd">        &gt;&gt;&gt; db.connect()</span>
<span class="sd">        &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">        &gt;&gt;&gt; fs = scan.get_fileset("fileset_001")</span>
<span class="sd">        &gt;&gt;&gt; fs.list_files()</span>
<span class="sd">        ['dummy_image', 'test_image', 'test_json']</span>
<span class="sd">        &gt;&gt;&gt; f = fs.get_file('dummy_image')</span>
<span class="sd">        &gt;&gt;&gt; f.path()  # should be '/tmp/romidb_********/myscan_001/fileset_001/dummy_image.png'</span>
<span class="sd">        &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>


<span class="c1">##################################################################</span>
<span class="c1">#</span>
<span class="c1"># the ugly stuff...</span>
<span class="c1">#</span>

<span class="c1"># load the database</span>

<span class="k">def</span> <span class="nf">_load_scans</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Load list of ``Scan`` from given database.</span>

<span class="sd">    List subdirectories of ``db.basedir``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    db : plantdb.fsdb.FSDB</span>
<span class="sd">        The database object to use to get the list of ``fsdb.Scan``</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of plantdb.fsdb.Scan</span>
<span class="sd">         The list of ``fsdb.Scan`` found in the database.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.fsdb._scan_path</span>
<span class="sd">    plantdb.fsdb._scan_files_json</span>
<span class="sd">    plantdb.fsdb._load_scan_filesets</span>
<span class="sd">    plantdb.fsdb._load_scan_metadata</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from plantdb.fsdb import FSDB</span>
<span class="sd">    &gt;&gt;&gt; from plantdb.fsdb import dummy_db, _load_scans</span>
<span class="sd">    &gt;&gt;&gt; db = dummy_db()</span>
<span class="sd">    &gt;&gt;&gt; db.connect()</span>
<span class="sd">    &gt;&gt;&gt; db.create_scan("007")</span>
<span class="sd">    &gt;&gt;&gt; db.create_scan("111")</span>
<span class="sd">    &gt;&gt;&gt; scans = _load_scans(db)</span>
<span class="sd">    &gt;&gt;&gt; print(scans)</span>
<span class="sd">    []</span>
<span class="sd">    &gt;&gt;&gt; db = dummy_db(with_fileset=True)</span>
<span class="sd">    &gt;&gt;&gt; db.connect()</span>
<span class="sd">    &gt;&gt;&gt; scans = _load_scans(db)</span>
<span class="sd">    &gt;&gt;&gt; print(scans)</span>
<span class="sd">    [&lt;plantdb.fsdb.Scan object at 0x7fa01220bd50&gt;]</span>

<span class="sd">    """</span>
    <span class="n">scans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">path</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="n">Scan</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_scan_path</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="c1"># If the `files.json` associated to the scan is found, parse it:</span>
            <span class="k">if</span> <span class="n">_scan_json_file</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">scan</span><span class="o">.</span><span class="n">filesets</span> <span class="o">=</span> <span class="n">_load_scan_filesets</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
                <span class="n">scan</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">_load_scan_metadata</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
                <span class="n">scan</span><span class="o">.</span><span class="n">measures</span> <span class="o">=</span> <span class="n">_load_scan_measures</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
            <span class="n">scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scans</span>


<span class="k">def</span> <span class="nf">_load_scan_filesets</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Load the list of ``Fileset`` from given `scan` dataset.</span>

<span class="sd">    Load the list of filesets using "filesets" top-level entry from ``files.json``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        The instance to use to get the list of ``Fileset``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of plantdb.fsdb.Fileset</span>
<span class="sd">         The list of ``Fileset`` found in the scan.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.fsdb._scan_files_json</span>
<span class="sd">    plantdb.fsdb._load_scan_filesets</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    May delete a fileset if unable to load it!</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from plantdb.fsdb import FSDB</span>
<span class="sd">    &gt;&gt;&gt; from plantdb.fsdb import dummy_db, _load_scan_filesets</span>
<span class="sd">    &gt;&gt;&gt; db = dummy_db(with_fileset=True)</span>
<span class="sd">    &gt;&gt;&gt; db.connect()</span>
<span class="sd">    &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">    &gt;&gt;&gt; fs = _load_scan_filesets(scan)</span>
<span class="sd">    &gt;&gt;&gt; print(fs)</span>
<span class="sd">    [&lt;plantdb.fsdb.Fileset object at 0x7fa0122232d0&gt;]</span>

<span class="sd">    """</span>
    <span class="n">filesets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Get the path to the `files.json` associated to the `scan`:</span>
    <span class="n">files_json</span> <span class="o">=</span> <span class="n">_scan_json_file</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
    <span class="c1"># Load it:</span>
    <span class="k">with</span> <span class="n">files_json</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="c1"># Get the list of info (dict) about the filesets</span>
    <span class="n">filesets_info</span> <span class="o">=</span> <span class="n">structure</span><span class="p">[</span><span class="s2">"filesets"</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filesets_info</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">fileset_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filesets_info</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fileset</span> <span class="o">=</span> <span class="n">_load_fileset</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">fileset_info</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FilesetNoIDError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not get an 'id' entry for the </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">-th 'filesets' entry from '</span><span class="si">{</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Current `fileset_info`: </span><span class="si">{</span><span class="n">fileset_info</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FilesetNotFoundError</span><span class="p">:</span>
                <span class="n">fsid</span> <span class="o">=</span> <span class="n">fileset_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Fileset directory '</span><span class="si">{</span><span class="n">fsid</span><span class="si">}</span><span class="s2">' not found for scan </span><span class="si">{</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, skip it."</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filesets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileset</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not find a list of filesets in '</span><span class="si">{</span><span class="n">files_json</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filesets</span>


<span class="k">def</span> <span class="nf">_load_fileset</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">fileset_info</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Load a fileset and set its attributes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        The scan object to use to get the list of ``fsdb.Fileset``</span>
<span class="sd">    fileset_info: dict</span>
<span class="sd">        Dictionary with the fileset id and listing its files, ``{'files': [], 'id': str}``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plantdb.fsdb.Fileset</span>
<span class="sd">        A fileset with its ``files`` &amp; ``metadata`` attributes restored.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import json</span>
<span class="sd">    &gt;&gt;&gt; from plantdb.fsdb import dummy_db, _load_fileset, _scan_json_file</span>
<span class="sd">    &gt;&gt;&gt; db = dummy_db(with_file=True)</span>
<span class="sd">    &gt;&gt;&gt; db.connect()</span>
<span class="sd">    &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">    &gt;&gt;&gt; db.disconnect()</span>
<span class="sd">    &gt;&gt;&gt; json_path = _scan_json_file(scan)</span>
<span class="sd">    &gt;&gt;&gt; with json_path.open(mode="r") as f: structure = json.load(f)</span>
<span class="sd">    &gt;&gt;&gt; filesets_info = structure["filesets"]</span>
<span class="sd">    &gt;&gt;&gt; fs = _load_fileset(scan, filesets_info[0])</span>
<span class="sd">    &gt;&gt;&gt; print(fs.id)</span>
<span class="sd">    fileset_001</span>
<span class="sd">    &gt;&gt;&gt; print([f.id for f in files])</span>
<span class="sd">    ['dummy_image', 'test_image', 'test_json']</span>

<span class="sd">    """</span>
    <span class="n">fileset</span> <span class="o">=</span> <span class="n">_parse_fileset</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">fileset_info</span><span class="p">)</span>
    <span class="n">fileset</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">_load_fileset_files</span><span class="p">(</span><span class="n">fileset</span><span class="p">,</span> <span class="n">fileset_info</span><span class="p">)</span>
    <span class="n">fileset</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">_load_fileset_metadata</span><span class="p">(</span><span class="n">fileset</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fileset</span>


<div class="viewcode-block" id="FilesetNoIDError"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.FilesetNoIDError">[docs]</a><span class="k">class</span> <span class="nc">FilesetNoIDError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""No 'id' entry could be found for this fileset."""</span></div>


<div class="viewcode-block" id="FilesetNotFoundError"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.FilesetNotFoundError">[docs]</a><span class="k">class</span> <span class="nc">FilesetNotFoundError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Could not find the fileset directory."""</span></div>


<span class="k">def</span> <span class="nf">_parse_fileset</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">fileset_info</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get a `Fileset` instance for given `db` &amp; `scan` by parsing provided `fileset_info`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    db : plantdb.fsdb.FSDB</span>
<span class="sd">        The database instance to associate the returned ``Fileset`` to.</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        The scan instance to associate the returned ``Fileset`` to.</span>
<span class="sd">    fileset_info : dict</span>
<span class="sd">        The fileset dictionary with the fileset 'id' entry</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plantdb.fsdb.Fileset</span>
<span class="sd">        The ``Fileset`` instance from parsed JSON.</span>

<span class="sd">    """</span>
    <span class="n">fsid</span> <span class="o">=</span> <span class="n">fileset_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fsid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">FilesetNoIDError</span><span class="p">(</span><span class="s2">"Fileset: No ID"</span><span class="p">)</span>

    <span class="n">fileset</span> <span class="o">=</span> <span class="n">Fileset</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">fsid</span><span class="p">)</span>
    <span class="c1"># Get the expected directory path and check it exists:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">_fileset_path</span><span class="p">(</span><span class="n">fileset</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Missing fileset directory: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">FilesetNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Fileset directory '</span><span class="si">{</span><span class="n">fsid</span><span class="si">}</span><span class="s2">' not found for scan '</span><span class="si">{</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fileset</span>


<span class="k">def</span> <span class="nf">_load_fileset_files</span><span class="p">(</span><span class="n">fileset</span><span class="p">,</span> <span class="n">fileset_info</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Load the list of ``File`` from given `fileset`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileset : plantdb.fsdb.Fileset</span>
<span class="sd">        The instance to use to get the list of ``File``.</span>
<span class="sd">    fileset_info : dict</span>
<span class="sd">        Dictionary with the fileset id and listing its files, ``{'files': [], 'id': str}``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of plantdb.fsdb.File</span>
<span class="sd">         The list of ``File`` found in the `fileset`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.fsdb._load_file</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    May delete a file if unable to load it!</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import json</span>
<span class="sd">    &gt;&gt;&gt; from plantdb.fsdb import FSDB</span>
<span class="sd">    &gt;&gt;&gt; from plantdb.fsdb import dummy_db, _scan_json_file, _parse_fileset, _load_fileset_files</span>
<span class="sd">    &gt;&gt;&gt; db = dummy_db(with_fileset=True, with_file=True)</span>
<span class="sd">    &gt;&gt;&gt; db.connect()</span>
<span class="sd">    &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">    &gt;&gt;&gt; db.disconnect()</span>
<span class="sd">    &gt;&gt;&gt; json_path = _scan_json_file(scan)</span>
<span class="sd">    &gt;&gt;&gt; with json_path.open(mode="r") as f: structure = json.load(f)</span>
<span class="sd">    &gt;&gt;&gt; filesets_info = structure["filesets"]</span>
<span class="sd">    &gt;&gt;&gt; fileset = _parse_fileset(scan.db, scan, filesets_info[0])</span>
<span class="sd">    &gt;&gt;&gt; files = _load_fileset_files(fileset, filesets_info[0])</span>
<span class="sd">    &gt;&gt;&gt; print([f.id for f in files])</span>
<span class="sd">    ['dummy_image', 'test_image', 'test_json']</span>

<span class="sd">    """</span>
    <span class="n">scan_id</span> <span class="o">=</span> <span class="n">fileset</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">files_info</span> <span class="o">=</span> <span class="n">fileset_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"files"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files_info</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files_info</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">_load_file</span><span class="p">(</span><span class="n">fileset</span><span class="p">,</span> <span class="n">file_info</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FileNoIDError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not get an 'id' entry for the </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">-th 'files' entry from '</span><span class="si">{</span><span class="n">scan_id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Current `file_info`: </span><span class="si">{</span><span class="n">file_info</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FileNoFileNameError</span><span class="p">:</span>
                <span class="n">fs_id</span> <span class="o">=</span> <span class="n">fileset</span><span class="o">.</span><span class="n">id</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not get a 'file' entry for file id '</span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s2">' from '</span><span class="si">{</span><span class="n">scan_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">fs_id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Current `file_info`: </span><span class="si">{</span><span class="n">file_info</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">fs_id</span> <span class="o">=</span> <span class="n">fileset</span><span class="o">.</span><span class="n">id</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"file"</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not find file '</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">' for '</span><span class="si">{</span><span class="n">scan_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">fs_id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Current `file_info`: </span><span class="si">{</span><span class="n">file_info</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Expected a list of files in `files.json` from dataset '</span><span class="si">{</span><span class="n">fileset</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'!"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">files</span>


<span class="k">def</span> <span class="nf">_load_fileset_metadata</span><span class="p">(</span><span class="n">fileset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Load the metadata for a fileset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileset : plantdb.fsdb.Fileset</span>
<span class="sd">        The fileset to load the metadata for.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The metadata dictionary.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">_load_metadata</span><span class="p">(</span><span class="n">_fileset_metadata_json_path</span><span class="p">(</span><span class="n">fileset</span><span class="p">))</span>


<div class="viewcode-block" id="FileNoIDError"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.FileNoIDError">[docs]</a><span class="k">class</span> <span class="nc">FileNoIDError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""No 'id' entry could be found for this file."""</span></div>


<div class="viewcode-block" id="FileNoFileNameError"><a class="viewcode-back" href="../../reference/fsdb.html#plantdb.fsdb.FileNoFileNameError">[docs]</a><span class="k">class</span> <span class="nc">FileNoFileNameError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""No 'file' entry could be found for this file."""</span></div>


<span class="k">def</span> <span class="nf">_load_file</span><span class="p">(</span><span class="n">fileset</span><span class="p">,</span> <span class="n">file_info</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get a `File` instance for given `fileset` using provided `file_info`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileset : plantdb.fsdb.Fileset</span>
<span class="sd">        The instance to associate the returned ``File`` to.</span>
<span class="sd">    file_info : dict</span>
<span class="sd">        Dictionary with the file 'id' and 'file' entries, ``{'file': str, 'id': str}``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plantdb.fsdb.File</span>
<span class="sd">        The `File` instance with metadata.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.fsdb._parse_file</span>
<span class="sd">    plantdb.fsdb._load_file_metadata</span>
<span class="sd">    """</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">_parse_file</span><span class="p">(</span><span class="n">fileset</span><span class="p">,</span> <span class="n">file_info</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">_load_file_metadata</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">file</span>


<span class="k">def</span> <span class="nf">_parse_file</span><span class="p">(</span><span class="n">fileset</span><span class="p">,</span> <span class="n">file_info</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get a `File` instance for given `fileset` by parsing provided `file_info`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileset : plantdb.fsdb.Fileset</span>
<span class="sd">        The fileset instance to associate the returned ``File`` to.</span>
<span class="sd">    file_info : dict</span>
<span class="sd">        The file dictionary with the file 'id' and 'file' entries, ``{'file': str, 'id': str}``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plantdb.fsdb.File</span>
<span class="sd">        The ``File`` instance from parsed JSON.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNoIDError</span>
<span class="sd">        If the 'id' entry is missing from `file_info`.</span>
<span class="sd">    FileNoFileNameError</span>
<span class="sd">        If the 'file' entry is missing from `file_info`.</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        If the file is not found on drive.</span>
<span class="sd">    """</span>
    <span class="n">fid</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Input `file_info`: </span><span class="si">{</span><span class="n">file_info</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">FileNoIDError</span><span class="p">(</span><span class="s2">"File: No ID"</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"file"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Input `file_info`: </span><span class="si">{</span><span class="n">file_info</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">FileNoFileNameError</span><span class="p">(</span><span class="s2">"File: No filename"</span><span class="p">)</span>

    <span class="n">file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">fileset</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">fileset</span><span class="p">,</span> <span class="n">fid</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>  <span class="c1"># set the filename attribute</span>
    <span class="c1"># Get the expected file path and check it exists:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">_file_path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Missing file: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">"File: Not found"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">file</span>


<span class="c1"># load/store metadata from disk</span>

<span class="k">def</span> <span class="nf">_load_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Load a metadata dictionary from a JSON file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str or pathlib.Path</span>
<span class="sd">        The path to the file containing the metadata to load.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The metadata dictionary.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IOError</span>
<span class="sd">        If the data returned by ``json.load`` is not a dictionary.</span>
<span class="sd">    """</span>
    <span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">JSONDecodeError</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">md</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">md</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">JSONDecodeError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not load JSON file '</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not obtain a dictionary from JSON: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not find JSON file '</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">md</span>


<span class="k">def</span> <span class="nf">_load_measures</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Load a measure dictionary from a JSON file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str or pathlib.Path</span>
<span class="sd">        The path to the file containing the measure to load.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The measure dictionary.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IOError</span>
<span class="sd">        If the data returned by ``json.load`` is not a dictionary.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">_load_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_load_scan_metadata</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Load the metadata for a dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        The dataset to load the metadata for.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The metadata dictionary.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">_load_metadata</span><span class="p">(</span><span class="n">_scan_metadata_path</span><span class="p">(</span><span class="n">scan</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_load_scan_measures</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Load the measures for a dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        The dataset to load the measures for.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The measures dictionary.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">_load_measures</span><span class="p">(</span><span class="n">_scan_measures_path</span><span class="p">(</span><span class="n">scan</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_load_file_metadata</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Load the metadata for a file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : plantdb.fsdb.File</span>
<span class="sd">        The file to load the metadata for.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The metadata dictionary.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">_load_metadata</span><span class="p">(</span><span class="n">_file_metadata_path</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_mkdir_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create the parent directories from given path.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str or pathlib.Path</span>
<span class="sd">        The path to a file.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Used to check the availability of the 'metadata' directory inside a dataset.</span>
<span class="sd">    """</span>
    <span class="nb">dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="nb">dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_store_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Save a metadata dictionary as a JSON file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str or pathlib.Path</span>
<span class="sd">        JSON file path to use for saving the metadata.</span>
<span class="sd">    metadata : dict</span>
<span class="sd">        The metadata dictionary to save.</span>
<span class="sd">    """</span>
    <span class="n">_mkdir_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span> <span class="s1">': '</span><span class="p">))</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_store_scan_metadata</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Save the metadata for a dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        The dataset to save the metadata for.</span>
<span class="sd">    """</span>
    <span class="n">_store_metadata</span><span class="p">(</span><span class="n">_scan_metadata_path</span><span class="p">(</span><span class="n">scan</span><span class="p">),</span> <span class="n">scan</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_store_fileset_metadata</span><span class="p">(</span><span class="n">fileset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Save the metadata for a dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.Fileset</span>
<span class="sd">        The fileset to save the metadata for.</span>
<span class="sd">    """</span>
    <span class="n">_store_metadata</span><span class="p">(</span><span class="n">_fileset_metadata_json_path</span><span class="p">(</span><span class="n">fileset</span><span class="p">),</span> <span class="n">fileset</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_store_file_metadata</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Save the metadata for a dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.File</span>
<span class="sd">        The file to save the metadata for.</span>
<span class="sd">    """</span>
    <span class="n">_store_metadata</span><span class="p">(</span><span class="n">_file_metadata_path</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">file</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_get_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get a copy of `metadata[key]`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    metadata : dict, optional</span>
<span class="sd">        The metadata dictionary to get the key from.</span>
<span class="sd">    key : str, optional</span>
<span class="sd">        The key to get from the metadata dictionary.</span>
<span class="sd">        If the key is not found, return ``None``.</span>
<span class="sd">        By default, return a copy of the whole metadata dictionary.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Any</span>
<span class="sd">        the value save under `metadata[key]`, if any.</span>
<span class="sd">    """</span>
    <span class="c1"># Do a deepcopy of the value because we don't want the caller to inadvertently change the values.</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_set_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Set a `data` `value` in `metadata` dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    metadata : dict</span>
<span class="sd">        The metadata dictionary to get the key from.</span>
<span class="sd">    data : str or dict</span>
<span class="sd">        If a string, a key to address the `value`.</span>
<span class="sd">        If a dictionary, update the metadata dictionary with `data` (`value` is then unused).</span>
<span class="sd">    value : any, optional</span>
<span class="sd">        The value to assign to `data` if the latest is not a dictionary.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IOError</span>
<span class="sd">        If `value` is `None` when `data` is a string.</span>
<span class="sd">        If `data` is not of the right type.</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"No value given for key '</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">'!"</span><span class="p">)</span>
        <span class="c1"># Do a deepcopy of the value because we don't want the caller to inadvertently change the values.</span>
        <span class="n">metadata</span><span class="p">[</span><span class="n">data</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_set_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid key: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_get_filename</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Returns a `file` name using its ``id`` attribute and given extension.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : plantdb.fsdb.File</span>
<span class="sd">        A File object.</span>
<span class="sd">    ext : str</span>
<span class="sd">        The file extension to use.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The corresponding file's name.</span>
<span class="sd">    """</span>
    <span class="c1"># Remove starting dot from extension:</span>
    <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'.'</span><span class="p">):</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">"</span>


<span class="c1">################################################################################</span>
<span class="c1"># paths - creators</span>
<span class="c1">################################################################################</span>

<span class="k">def</span> <span class="nf">_make_fileset</span><span class="p">(</span><span class="n">fileset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create the fileset directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileset : plantdb.fsdb.Fileset</span>
<span class="sd">        The fileset to use for directory creation.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.fsdb._fileset_path</span>
<span class="sd">    """</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">_fileset_path</span><span class="p">(</span><span class="n">fileset</span><span class="p">)</span>
    <span class="c1"># Create the fileset directory if it does not exist:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_make_scan</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create the scan directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        The scan to use for directory creation.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.fsdb._scan_path</span>
<span class="sd">    """</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">_scan_path</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
    <span class="c1"># Create the scan directory if it does not exist:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span>


<span class="c1">################################################################################</span>
<span class="c1"># paths - getters</span>
<span class="c1">################################################################################</span>


<span class="k">def</span> <span class="nf">_scan_path</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get the path to given scan.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        The scan to get the path from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pathlib.Path</span>
<span class="sd">        The path to the scan directory.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">basedir</span> <span class="o">/</span> <span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_scan_json_file</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get the path to scan's "files.json" file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        The scan to get the files JSON file path from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pathlib.Path</span>
<span class="sd">        Path to the scan's "files.json" file.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">_scan_path</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span> <span class="o">/</span> <span class="s2">"files.json"</span>


<span class="k">def</span> <span class="nf">_scan_metadata_path</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get the path to scan's "metadata.json" file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        The scan to get the metadata JSON file path from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pathlib.Path</span>
<span class="sd">        Path to the scan's "metadata.json" file.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">_scan_path</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span> <span class="o">/</span> <span class="s2">"metadata"</span> <span class="o">/</span> <span class="s2">"metadata.json"</span>


<span class="k">def</span> <span class="nf">_scan_measures_path</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get the path to scan's "measures.json" file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        The scan to get the measures JSON file path from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pathlib.Path</span>
<span class="sd">        Path to the scan's "measures.json" file.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">_scan_path</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span> <span class="o">/</span> <span class="s2">"measures.json"</span>


<span class="k">def</span> <span class="nf">_fileset_path</span><span class="p">(</span><span class="n">fileset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get the path to given fileset directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileset : plantdb.fsdb.Fileset</span>
<span class="sd">        The fileset to get the path from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pathlib.Path</span>
<span class="sd">        The path to the fileset directory.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">_scan_path</span><span class="p">(</span><span class="n">fileset</span><span class="o">.</span><span class="n">scan</span><span class="p">)</span> <span class="o">/</span> <span class="n">fileset</span><span class="o">.</span><span class="n">id</span>


<span class="k">def</span> <span class="nf">_fileset_metadata_path</span><span class="p">(</span><span class="n">fileset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get the path to given fileset metadata directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileset : plantdb.fsdb.Fileset</span>
<span class="sd">        The fileset to get the metadata directory path from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pathlib.Path</span>
<span class="sd">        Path to the fileset metadata directory.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">_scan_path</span><span class="p">(</span><span class="n">fileset</span><span class="o">.</span><span class="n">scan</span><span class="p">)</span> <span class="o">/</span> <span class="s2">"metadata"</span> <span class="o">/</span> <span class="n">fileset</span><span class="o">.</span><span class="n">id</span>


<span class="k">def</span> <span class="nf">_fileset_metadata_json_path</span><span class="p">(</span><span class="n">fileset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get the path to `fileset.id` metadata JSON file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileset : plantdb.fsdb.Fileset</span>
<span class="sd">        Fileset to get the JSON file path from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pathlib.Path</span>
<span class="sd">        Path to the f`fileset.id` metadata JSON file.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">_scan_path</span><span class="p">(</span><span class="n">fileset</span><span class="o">.</span><span class="n">scan</span><span class="p">)</span> <span class="o">/</span> <span class="s2">"metadata"</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">fileset</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.json"</span>


<span class="k">def</span> <span class="nf">_file_path</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get the path to given file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : plantdb.fsdb.File</span>
<span class="sd">        The file to get the path from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pathlib.Path</span>
<span class="sd">        The path to the file.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">_fileset_path</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">fileset</span><span class="p">)</span> <span class="o">/</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span>


<span class="k">def</span> <span class="nf">_file_metadata_path</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get the path to `file.id` metadata JSON file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : plantdb.fsdb.File</span>
<span class="sd">        File to get the metadata JSON path from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pathlib.Path</span>
<span class="sd">        Path to the "&lt;File.id&gt;.json" file.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">_scan_path</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">fileset</span><span class="o">.</span><span class="n">scan</span><span class="p">)</span> <span class="o">/</span> <span class="s2">"metadata"</span> <span class="o">/</span> <span class="n">file</span><span class="o">.</span><span class="n">fileset</span><span class="o">.</span><span class="n">id</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.json"</span>


<span class="c1">################################################################################</span>
<span class="c1"># store a scan to disk</span>
<span class="c1">################################################################################</span>

<span class="k">def</span> <span class="nf">_file_to_dict</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Returns a dict with the file "id" and "filename".</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : plantdb.fsdb.File</span>
<span class="sd">        File to get "id" and "filename" from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        ``{"id": file.get_id(), "file": file.filename}``</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">get_id</span><span class="p">(),</span> <span class="s2">"file"</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">_fileset_to_dict</span><span class="p">(</span><span class="n">fileset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Returns a dict with the fileset "id" and the "files" dict.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileset : plantdb.fsdb.Fileset</span>
<span class="sd">        Fileset to get "id" and "files" dictionary from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        ``{"id": fileset.get_id(), "files": {"id": file.get_id(), "file": file.filename}}``</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.fsdb._file_to_dict</span>
<span class="sd">    """</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fileset</span><span class="o">.</span><span class="n">get_files</span><span class="p">():</span>
        <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_file_to_dict</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="n">fileset</span><span class="o">.</span><span class="n">get_id</span><span class="p">(),</span> <span class="s2">"files"</span><span class="p">:</span> <span class="n">files</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">_scan_to_dict</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Returns a dict with the scan's filesets and files structure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        Scan instance to get underlying filesets and files structure from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        ``{"filesets": {"id": fileset.get_id(), "files": {"id": file.get_id(), "file": file.filename}}}``</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.fsdb._fileset_to_dict</span>
<span class="sd">    plantdb.fsdb._file_to_dict</span>
<span class="sd">    """</span>
    <span class="n">filesets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fileset</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">get_filesets</span><span class="p">():</span>
        <span class="n">filesets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_fileset_to_dict</span><span class="p">(</span><span class="n">fileset</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"filesets"</span><span class="p">:</span> <span class="n">filesets</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">_store_scan</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Dump the fileset and files structure associated to a `scan` on drive.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        Scan instance to save by dumping its underlying structure in its "files.json".</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.fsdb._scan_to_dict</span>
<span class="sd">    plantdb.fsdb._scan_files_json</span>
<span class="sd">    """</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="n">_scan_to_dict</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
    <span class="n">files_json</span> <span class="o">=</span> <span class="n">_scan_json_file</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">files_json</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span> <span class="s1">': '</span><span class="p">))</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_is_valid_id</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># haha  (FIXME!)</span>


<span class="k">def</span> <span class="nf">_is_fsdb</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Test if the given path is indeed an FSDB database.</span>

<span class="sd">    Do it by checking the presence of the ``MARKER_FILE_NAME``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str or pathlib.Path</span>
<span class="sd">        A path to test as a valid FSDB database.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        ``True`` if an FSDB database, else ``False``.</span>
<span class="sd">    """</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">marker_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="n">MARKER_FILE_NAME</span>
    <span class="k">return</span> <span class="n">marker_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_is_safe_to_delete</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Tests if given path is safe to delete.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str or pathlib.Path</span>
<span class="sd">        A path to test for safe deletion.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        ``True`` if the path is safe to delete, else ``False``.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    A path is safe to delete only if it's a sub-folder of a db.</span>
<span class="sd">    """</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Test if the current path is a local DB (FSDB):</span>
        <span class="k">if</span> <span class="n">_is_fsdb</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># exit and return `True` if it is</span>
        <span class="c1"># Else, move to the parent directory &amp; try again:</span>
        <span class="n">newpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">parent</span>
        <span class="c1"># Check if we have indeed moved up to the parent directory</span>
        <span class="k">if</span> <span class="n">newpath</span> <span class="o">==</span> <span class="n">path</span><span class="p">:</span>
            <span class="c1"># Stop if we did not</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">newpath</span>


<span class="k">def</span> <span class="nf">_delete_file</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Delete the given file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : plantdb.fsdb.File</span>
<span class="sd">        The file instance to delete.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IOError</span>
<span class="sd">        If the file path is outside the database.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    We have to delete:</span>
<span class="sd">      - the JSON metadata file associated to the file.</span>
<span class="sd">      - the file</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.fsdb._file_path</span>
<span class="sd">    plantdb.fsdb._is_safe_to_delete</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># The filename attribute is defined when the file is written!</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"No 'filename' attribute defined for file id '</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"It means the file is not written on disk."</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">file_path</span> <span class="o">=</span> <span class="n">_file_path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_safe_to_delete</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File </span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2"> is not in the current database."</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File path: '</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">"Cannot delete files or directories outside of a local DB."</span><span class="p">)</span>

    <span class="c1"># - Delete the JSON metadata file associated to the `File` instance:</span>
    <span class="n">file_md_path</span> <span class="o">=</span> <span class="n">_file_metadata_path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">file_md_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_md_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Could not delete the JSON metadata file for file '</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">' from '</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">fileset</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">fileset</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"JSON metadata file path: '</span><span class="si">{</span><span class="n">file_md_path</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Deleted JSON metadata file for file '</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">' from '</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">fileset</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">fileset</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>

    <span class="c1"># - Delete the file associated to the `File` instance:</span>
    <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not delete file '</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">' from '</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">fileset</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">fileset</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File path: '</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Deleted file '</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">' from '</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">fileset</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">fileset</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_delete_fileset</span><span class="p">(</span><span class="n">fileset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Delete the given fileset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileset : plantdb.fsdb.Fileset</span>
<span class="sd">        The fileset instance to delete.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IOError</span>
<span class="sd">        If the fileset path is outside the database.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    We have to delete:</span>
<span class="sd">      - the files in the fileset</span>
<span class="sd">      - the fileset JSON metadata file</span>
<span class="sd">      - the fileset metadata directory</span>
<span class="sd">      - the fileset directory</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.fsdb._scan_path</span>
<span class="sd">    plantdb.fsdb._fileset_path</span>
<span class="sd">    plantdb.fsdb._is_safe_to_delete</span>
<span class="sd">    """</span>
    <span class="n">fileset_path</span> <span class="o">=</span> <span class="n">_fileset_path</span><span class="p">(</span><span class="n">fileset</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_safe_to_delete</span><span class="p">(</span><span class="n">fileset_path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Fileset </span><span class="si">{</span><span class="n">fileset</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> is not in the current database."</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Fileset path: '</span><span class="si">{</span><span class="n">fileset_path</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">"Cannot delete files or directories outside of a local DB."</span><span class="p">)</span>

    <span class="c1"># - Delete the `Files` (and their metadata) belonging to the `Fileset` instance:</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fileset</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
        <span class="n">fileset</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="c1"># - Delete the JSON metadata file associated to the `Fileset` instance:</span>
    <span class="n">json_md</span> <span class="o">=</span> <span class="n">_fileset_metadata_json_path</span><span class="p">(</span><span class="n">fileset</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">json_md</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">missing_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not find the JSON metadata file for fileset '</span><span class="si">{</span><span class="n">fileset</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"JSON metadata file path: '</span><span class="si">{</span><span class="n">json_md</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Deleted the JSON metadata file for fileset '</span><span class="si">{</span><span class="n">fileset</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>

    <span class="c1"># - Delete the metadata directory associated to the `Fileset` instance:</span>
    <span class="n">dir_md</span> <span class="o">=</span> <span class="n">_fileset_metadata_path</span><span class="p">(</span><span class="n">fileset</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rmtree</span><span class="p">(</span><span class="n">dir_md</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not find metadata directory for fileset '</span><span class="si">{</span><span class="n">fileset</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Metadata directory path: '</span><span class="si">{</span><span class="n">dir_md</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Deleted metadata directory for fileset '</span><span class="si">{</span><span class="n">fileset</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>

    <span class="c1"># - Delete the directory associated to the `Fileset` instance:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rmtree</span><span class="p">(</span><span class="n">fileset_path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not find directory for fileset '</span><span class="si">{</span><span class="n">fileset</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Fileset directory path: '</span><span class="si">{</span><span class="n">fileset_path</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Deleted directory for fileset '</span><span class="si">{</span><span class="n">fileset</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_delete_scan</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Delete the given scan, starting by its `Fileset`s.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scan : plantdb.fsdb.Scan</span>
<span class="sd">        The scan instance to delete.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IOError</span>
<span class="sd">        If the scan path is outside the database.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    plantdb.fsdb._scan_path</span>
<span class="sd">    plantdb.fsdb._is_safe_to_delete</span>
<span class="sd">    """</span>
    <span class="n">scan_path</span> <span class="o">=</span> <span class="n">_scan_path</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_safe_to_delete</span><span class="p">(</span><span class="n">scan_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">"Cannot delete files outside of a DB."</span><span class="p">)</span>

    <span class="c1"># - Delete the whole directory will get rid of everything (metadata, filesets, files):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rmtree</span><span class="p">(</span><span class="n">scan_path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not find directory for scan '</span><span class="si">{</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Scan path: '</span><span class="si">{</span><span class="n">scan_path</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Deleted directory for scan '</span><span class="si">{</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">'."</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_filter_query</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Filter a list of `Scan`s, `Fileset`s or `File`s using a `query` on their metadata.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    l : list</span>
<span class="sd">        List of `Scan`s, `Fileset`s or `File`s to filter.</span>
<span class="sd">    query : dict, optional</span>
<span class="sd">        Filtering query in the form of a dictionary.</span>
<span class="sd">        The list of instances must have metadata matching ``key`` and ``value`` from the `query`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        List of `Scan`s, `Fileset`s or `File`s filtered by the query, if any.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from plantdb.fsdb import dummy_db</span>
<span class="sd">    &gt;&gt;&gt; from plantdb.fsdb import _filter_query</span>
<span class="sd">    &gt;&gt;&gt; db = dummy_db(with_scan=True, with_file=True)</span>
<span class="sd">    &gt;&gt;&gt; db.connect()</span>
<span class="sd">    &gt;&gt;&gt; scan = db.get_scan("myscan_001")</span>
<span class="sd">    &gt;&gt;&gt; fs = scan.get_fileset("fileset_001")</span>
<span class="sd">    &gt;&gt;&gt; print({f.id: f.metadata for f in fs.get_files()})</span>
<span class="sd">    {'dummy_image': {'dummy image': True}, 'test_image': {'random image': True}, 'test_json': {'random json': True}}</span>
<span class="sd">    &gt;&gt;&gt; files = _filter_query(fs.get_files(), query=None)</span>
<span class="sd">    &gt;&gt;&gt; print(len(files))  # no filtering so all three files are here!</span>
<span class="sd">    3</span>
<span class="sd">    &gt;&gt;&gt; files = _filter_query(fs.get_files(), query={"channel": "rgb"})</span>
<span class="sd">    &gt;&gt;&gt; print(len(files))  # should be empty as no file has this metadata</span>
<span class="sd">    0</span>
<span class="sd">    &gt;&gt;&gt; files = _filter_query(fs.get_files(), query={"random image": True})</span>
<span class="sd">    &gt;&gt;&gt; print(len(files))  # should be `1` as only one file has this metadata</span>
<span class="sd">    1</span>
<span class="sd">    &gt;&gt;&gt; db.disconnect()</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">query</span> <span class="o">==</span> <span class="p">{}:</span>
        <span class="c1"># If there is no `query` return the unfiltered list of instances</span>
        <span class="n">query_result</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Else apply the filter on metadata using key(s) and value(s) from `query`:</span>
        <span class="n">query_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">f_query</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># boolean list gathering the "filter test results"</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">==</span> <span class="n">query</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                    <span class="n">f_query</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f_query</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># All requirements have to be fulfilled:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">f_query</span><span class="p">):</span>
                <span class="n">query_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">query_result</span>
</pre></div>

          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2022, Robotics for Microfarms.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>